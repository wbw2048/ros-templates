ROSTemplateFormatVersion: '2015-09-01'
Transform: Aliyun::Terraform-v1.5
Parameters:
  app_username:
    ConstraintDescription:
      zh-cn: 3 到 63 个字母组成。
      en: 3 to 63 letters.
    Description:
      zh-cn: 在浏览器中登录示例应用程序时的用户名。
      en: Username when logging into the sample application in the browser.
    Label:
      zh-cn: 登录用户名
      en: Login Username
    AllowedPattern: ^[a-zA-Z-]{3,63}$
    Type: String
    AssociationProperty: AutoCompleteInput
    AssociationPropertyMetadata:
      Length: 5
      Prefix: demo-user-
      CharacterClasses:
      - Class: lowercase
        min: 1
  app_password:
    Type: String
    NoEcho: true
    Description:
      en: >-
        Server login password, Length 8-30, must contain three(Capital letters,
        lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special
        symbol in)
      zh-cn: >-
        在浏览器中登录示例应用程序时的密码，长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/
        中的特殊符号）
    Label:
      en: Login Password
      zh-cn: 登录密码
    ConstraintDescription:
      en: >-
        Length 8-30, must contain three(Capital letters, lowercase letters,
        numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in)
      zh-cn: 长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）
    AssociationProperty: ALIYUN::ECS::Instance::Password
  ecs_instance_password:
    NoEcho: true
    Type: String
    Description:
      en: Server login password, Length 8-30, must contain three(Capital 
        letters, lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 
        Special symbol in)
      zh-cn: 服务器登录密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 
        中的特殊符号）
    Label:
      en: ECS Instance Password
      zh-cn: ECS实例密码
    ConstraintDescription:
      en: Length 8-30, must contain three(Capital letters, lowercase letters, 
        numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in)
      zh-cn: 长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）
    AssociationProperty: ALIYUN::ECS::Instance::Password
  instance_type:
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
    AssociationPropertyMetadata:
      ZoneId: ${zone_id}
    Type: String
    Label:
      zh-cn: 实例类型
      en: Instance Type
  zone_id:
    AssociationProperty: ALIYUN::ECS::Instance::ZoneId
    AssociationPropertyMetadata:
      AutoSelectFirst: true
    Type: String
    Description:
      zh-cn: 可用区ID。<br><b>注： <font 
        color='blue'>选择可用区前请确认该可用区是否支持创建ECS资源的规格</font></b>
      en: Availability Zone ID,<br><b>note： <font color='blue'>Before selecting,
        please confirm that the Availability Zone supports the specification of 
        creating ECS resources</font></b>
    Label:
      zh-cn: 可用区ID
      en: Available Zone ID
  elasticsearch_password:
    NoEcho: true
    Type: String
    Label:
      en: Elasticsearch Instance Password
      zh-cn: Elasticsearch实例密码
    Description:
      en: Server login password, Length 8-30, must contain three(Capital 
        letters, lowercase letters, numbers, !@#$%^&*()_+-= Special symbol in)
      zh-cn: 服务器登录密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 !@#$%^&*()_+-= 中的特殊符号）
    AssociationProperty: ALIYUN::RDS::Instance::AccountPassword
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
    - Parameters:
      - zone_id
      - instance_type
      - instance_password
      Label:
        default: ECS
    - Parameters:
      - elasticsearch_password
      Label:
        default: Elasticsearch
    - Parameters:
      - app_username
      - app_password
      Label:
        default: APP
    TemplateTags:
    - acs:technical-solution:ai:使用Elasticsearch的向量检索能力进行个性化推荐-tech_solu_153
    Hidden:
    - vpc_cidr_block
    - vswitch_cidr_block
  ALIYUN::ROS::Composer:
    5748b038:
      Rect:
      - 580
      - 481
      - -102
      - 93
      - 1
      - 0
      ResT: Composer::ROSParameter::AlibabaCloud
    c414464f:
      Parent: 5748b038
      Rect:
      - 533
      - 411
      - -82
      - 143
      - 2
      - 0
      ResT: Composer::ROSParameter::Region
    1f674a92:
      Res:
      - InstallApp
      Parent: c414464f
      Rect:
      - 40
      - 40
      - -42
      - 381
      - 3
      - 0
    3b275f89:
      Res:
      - WaitConditionHandle
      Parent: c414464f
      Rect:
      - 40
      - 40
      - -42
      - 219
      - 3
      - 0
    6d499a30:
      Res:
      - WaitCondition
      Parent: c414464f
      Rect:
      - 40
      - 40
      - -42
      - 301
      - 3
      - 0
    72cb0af6:
      Res:
      - EcsVpc
      Parent: c414464f
      Rect:
      - 378
      - 337
      - 38
      - 192
      - 3
      - 0
    c64caf0f:
      Res:
      - ZoneId
      Parent: 72cb0af6
      Rect:
      - 345
      - 270
      - 58
      - 241
      - 4
      - 0
      ResT: Composer::ROSParameter::Zone
    60f238ea:
      Res:
      - EcsVSwitch
      Parent: c64caf0f
      Rect:
      - 267
      - 195
      - 78
      - 294
      - 5
      - 0
    29abe6f5:
      Res:
      - Elasticsearch
      Parent: 60f238ea
      Rect:
      - 40
      - 40
      - 258
      - 381
      - 6
      - 0
    ede1de2b:
      Res:
      - EcsSecurityGroup
      Parent: 72cb0af6
      Rect:
      - 89
      - 118
      - 98
      - 341
      - 10
      - 0
    '5e223263':
      Parent: c414464f
      Edge:
      - 1f674a92
      - 4042ea30
      Line: 0:0:0:gray:0
    ae11fc04:
      Parent: c414464f
      Edge:
      - 6d499a30
      - 3b275f89
      Line: 0:0:0:gray:0
    4042ea30:
      Res:
      - EcsInstance
      Parent: 60f238ea
      Rect:
      - 40
      - 40
      - 123
      - 381
      - 11
      - 0
      Layer:
      - ede1de2b
Workspace:
  variable.tf: |-
    # Parameters
    variable "zone_id" {
      type        = string
      description = "可用区ID"
      default     = "cn-hangzhou-j"
    }

    variable "instance_type" {
      type        = string
      description = "ECS实例类型"
      default     = "ecs.c6.large"
    }

    variable "app_username" {
      type        = string
      description = "应用程序登录用户名"
      default     = "demo-user"
      validation {
        condition     = can(regex("^[a-zA-Z-]{3,63}$", var.app_username))
        error_message = "3到63个字母组成"
      }
    }

    variable "app_password" {
      type        = string
      description = "应用程序登录密码，长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）"
      sensitive   = true
      validation {
        condition     = can(regex("^[0-9A-Za-z_\\-&:;'<>,=%`~!@#()$^*+|{}\\[\\].?/]+$", var.app_password)) && length(var.app_password) >= 8 && length(var.app_password) <= 30
        error_message = "长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）"
      }
    }

    variable "ecs_instance_password" {
      type        = string
      description = "ECS实例密码，长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）"
      sensitive   = true
      validation {
        condition     = can(regex("^[0-9A-Za-z_\\-&:;'<>,=%`~!@#()$^*+|{}\\[\\].?/]+$", var.ecs_instance_password)) && length(var.ecs_instance_password) >= 8 && length(var.ecs_instance_password) <= 30
        error_message = "长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）"
      }
    }

    variable "elasticsearch_password" {
      type        = string
      description = "Elasticsearch实例密码，长度8-30，必须包含三项（大写字母、小写字母、数字、 !@#$%^&*()_+-= 中的特殊符号）"
      sensitive   = true
      validation {
        condition     = can(regex("^[0-9A-Za-z!@#$%^&*()_+=-]+$", var.elasticsearch_password)) && length(var.elasticsearch_password) >= 8 && length(var.elasticsearch_password) <= 30
        error_message = "长度8-30，必须包含三项（大写字母、小写字母、数字、 !@#$%^&*()_+-= 中的特殊符号）"
      }
    }

    # VPC and VSwitch CIDR blocks
    variable "vpc_cidr_block" {
      type        = string
      description = "VPC的CIDR块"
      default     = "192.168.0.0/16"
    }

    variable "vswitch_cidr_block" {
      type        = string
      description = "交换机的CIDR块"
      default     = "192.168.1.0/24"
    }
  main.tf: |-
    provider "alicloud" {
    }
    data "alicloud_images" "default" {
      name_regex  = "^aliyun_3_x64_20G_alibase_.*"
      most_recent = true
      owners      = "system"
    }
    resource "random_id" "suffix" {
      byte_length = 8
    }

    locals {
      common_name    = random_id.suffix.hex
      install_script = <<-SCRIPT
    #!/bin/bash
    cat << EOF >> ~/.bash_profile
    export DEMO_ES_HOST='${alicloud_elasticsearch_instance.elasticsearch.domain}'
    export DEMO_ES_PORT=9200
    export DEMO_ES_USERNAME=elastic
    export DEMO_ES_PASSWORD='${var.elasticsearch_password}'

    export DEMO_USERNAME='${var.app_username}'
    export DEMO_PASSWORD='${var.app_password}'
    export ROS_DEPLOY=true
    EOF

    source ~/.bash_profile

    curl -fsSL https://help-static-aliyun-doc.aliyuncs.com/install-script/elasticsearch-server/install.sh|bash
    SCRIPT
    }

    # Data source for current region
    data "alicloud_regions" "current" {
      current = true
    }

    # VPC Resources
    resource "alicloud_vpc" "vpc" {
      vpc_name   = "VPC-${local.common_name}"
      cidr_block = var.vpc_cidr_block
    }

    resource "alicloud_vswitch" "vswitch" {
      vpc_id       = alicloud_vpc.vpc.id
      cidr_block   = var.vswitch_cidr_block
      zone_id      = var.zone_id
      vswitch_name = "vsw-${local.common_name}"
    }

    # Security Group
    resource "alicloud_security_group" "security_group" {
      vpc_id              = alicloud_vpc.vpc.id
      security_group_name = "SecurityGroup-${local.common_name}"
      security_group_type = "normal"
    }

    resource "alicloud_security_group_rule" "http" {
      type              = "ingress"
      ip_protocol       = "tcp"
      port_range        = "80/80"
      cidr_ip           = "140.205.11.1/25"
      security_group_id = alicloud_security_group.security_group.id
    }

    # Elasticsearch Instance
    resource "alicloud_elasticsearch_instance" "elasticsearch" {
      instance_charge_type = "PostPaid"
      enable_public        = true
      version              = "7.10_with_X-Pack"
      data_node_amount     = 3
      data_node_disk_size  = 20
      data_node_disk_type  = "cloud_essd"
      data_node_spec       = "elasticsearch.sn1ne.large.new"
      vswitch_id           = alicloud_vswitch.vswitch.id
      password             = var.elasticsearch_password

      kibana_node_spec = "elasticsearch.n4.small"
    }

    # ECS Instance
    resource "alicloud_instance" "ecs_instance" {
      instance_name              = "ecs-${local.common_name}"
      system_disk_category       = "cloud_essd"
      system_disk_size           = 40
      image_id                   = data.alicloud_images.default.images.0.id
      vswitch_id                 = alicloud_vswitch.vswitch.id
      password                   = var.ecs_instance_password
      instance_type              = var.instance_type
      internet_max_bandwidth_out = 5
      security_groups            = [alicloud_security_group.security_group.id]
      availability_zone          = var.zone_id
    }

    # ECS Command for Installation
    resource "alicloud_ecs_command" "install_command" {
      name            = "install-elasticsearch-demo-${local.common_name}"
      description     = "Install Elasticsearch demo application"
      type            = "RunShellScript"
      command_content = base64encode(local.install_script)
      timeout         = 3600
      working_dir     = "/root"
    }

    # Execute installation on ECS instance
    resource "alicloud_ecs_invocation" "install_on_ecs" {
      instance_id = [alicloud_instance.ecs_instance.id]
      command_id  = alicloud_ecs_command.install_command.id
      depends_on = [
        alicloud_elasticsearch_instance.elasticsearch
      ]
      timeouts {
        create = "30m"
      }
    }
  output.tf: |-
    # Outputs
    output "demo_url" {
      description = "应用程序访问域名"
      value       = "http://${alicloud_instance.ecs_instance.public_ip}/elasticsearch-demo"
    }

    output "ecs_login_address" {
      description = "ECS登录地址"
      value       = "https://ecs-workbench.aliyun.com/?from=EcsConsole&instanceType=ecs&regionId=${data.alicloud_regions.current.regions.0.id}&instanceId=${alicloud_instance.ecs_instance.id}"
    }

    output "elasticsearch_domain" {
      description = "Elasticsearch域名"
      value       = alicloud_elasticsearch_instance.elasticsearch.domain
    }

    output "ecs_public_ip" {
      description = "ECS公网IP"
      value       = alicloud_instance.ecs_instance.public_ip
    }